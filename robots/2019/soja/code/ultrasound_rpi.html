<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>rpi/ultrasound.py - Ecam Eurobot</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="../../../../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="organization/organization.html"><strong aria-hidden="true">1.</strong> Organization</a></li><li><ol class="section"><li><a href="organization/github.html"><strong aria-hidden="true">1.1.</strong> GitHub</a></li><li><ol class="section"><li><a href="organization/gh-admin.html"><strong aria-hidden="true">1.1.1.</strong> Administration</a></li></ol></li><li><a href="organization/mdbook.html"><strong aria-hidden="true">1.2.</strong> mdBook</a></li></ol></li><li><a href="mechanical/mechanical.html"><strong aria-hidden="true">2.</strong> Mechanical</a></li><li><ol class="section"><li><a href="mechanical/fusion.html"><strong aria-hidden="true">2.1.</strong> 3D modeling with Fusion360</a></li><li><a href="mechanical/3d-print.html"><strong aria-hidden="true">2.2.</strong> 3D printing</a></li><li><a href="mechanical/mecanum.html"><strong aria-hidden="true">2.3.</strong> Mecanum wheels</a></li><li><a href="mechanical/vacuum.html"><strong aria-hidden="true">2.4.</strong> Vacuum prehention</a></li><li><a href="mechanical/2018/2018.html"><strong aria-hidden="true">2.5.</strong> 2018 specifics</a></li><li><ol class="section"><li><a href="mechanical/2018/bigRobot.html"><strong aria-hidden="true">2.5.1.</strong> Block mechanism</a></li><li><a href="mechanical/2018/balls.html"><strong aria-hidden="true">2.5.2.</strong> Ball mechanism</a></li></ol></li></ol></li><li><a href="electronics/electronics.html"><strong aria-hidden="true">3.</strong> Electronics</a></li><li><ol class="section"><li><a href="electronics/actuators/actuators.html"><strong aria-hidden="true">3.1.</strong> Actuators</a></li><li><ol class="section"><li><a href="electronics/actuators/dynamixels.html"><strong aria-hidden="true">3.1.1.</strong> Dynamixels</a></li></ol></li><li><a href="electronics/sensors/sensors.html"><strong aria-hidden="true">3.2.</strong> Sensors</a></li><li><ol class="section"><li><a href="electronics/sensors/sonar.html"><strong aria-hidden="true">3.2.1.</strong> Sonar</a></li><li><a href="electronics/sensors/coloursensor.html"><strong aria-hidden="true">3.2.2.</strong> Color Sensor</a></li><li><a href="electronics/sensors/mouse.html"><strong aria-hidden="true">3.2.3.</strong> Mouse</a></li></ol></li><li><a href="electronics/pcb/1_PCB_Design.html"><strong aria-hidden="true">3.3.</strong> PCB Design</a></li><li><ol class="section"><li><a href="electronics/pcb/2_Starting_Board.html"><strong aria-hidden="true">3.3.1.</strong> Start board</a></li><li><a href="electronics/pcb/3_Motor_Board.html"><strong aria-hidden="true">3.3.2.</strong> Motor board</a></li><li><a href="electronics/pcb/4_Com_Shield.html"><strong aria-hidden="true">3.3.3.</strong> Communication shield</a></li><li><a href="electronics/pcb/PowerSpply.html"><strong aria-hidden="true">3.3.4.</strong> Power supply board</a></li><li><a href="electronics/pcb/5_Appendix.html"><strong aria-hidden="true">3.3.5.</strong> Appendix</a></li></ol></li><li><a href="electronics/fpga.html"><strong aria-hidden="true">3.4.</strong> FPGA</a></li><li><a href="electronics/communication/communication.html"><strong aria-hidden="true">3.5.</strong> Communication</a></li><li><ol class="section"><li><a href="electronics/communication/i2c.html"><strong aria-hidden="true">3.5.1.</strong> I2C</a></li><li><a href="electronics/communication/spi.html"><strong aria-hidden="true">3.5.2.</strong> SPI</a></li><li><a href="electronics/communication/can.html"><strong aria-hidden="true">3.5.3.</strong> CAN</a></li></ol></li></ol></li><li><a href="software/software.html"><strong aria-hidden="true">4.</strong> Software</a></li><li><ol class="section"><li><a href="software/docker.html"><strong aria-hidden="true">4.1.</strong> Docker</a></li><li><a href="software/ros/ros.html"><strong aria-hidden="true">4.2.</strong> ROS</a></li><li><ol class="section"><li><a href="software/ros/install.html"><strong aria-hidden="true">4.2.1.</strong> Install</a></li><li><a href="software/ros/basics/basics.html"><strong aria-hidden="true">4.2.2.</strong> Basic concepts</a></li><li><ol class="section"><li><a href="software/ros/basics/workspace.html"><strong aria-hidden="true">4.2.2.1.</strong> Workspace setup</a></li><li><a href="software/ros/basics/packages.html"><strong aria-hidden="true">4.2.2.2.</strong> Packages</a></li><li><a href="software/ros/basics/pub.html"><strong aria-hidden="true">4.2.2.3.</strong> Publisher</a></li><li><a href="software/ros/basics/sub.html"><strong aria-hidden="true">4.2.2.4.</strong> Subscriber</a></li><li><a href="software/ros/basics/example.html"><strong aria-hidden="true">4.2.2.5.</strong> Example</a></li><li><a href="software/ros/basics/launch.html"><strong aria-hidden="true">4.2.2.6.</strong> Launchfiles</a></li><li><a href="software/ros/basics/params.html"><strong aria-hidden="true">4.2.2.7.</strong> ROS parameters</a></li><li><a href="software/ros/basics/practices.html"><strong aria-hidden="true">4.2.2.8.</strong> Good Practices</a></li></ol></li><li><a href="software/ros/rosserial.html"><strong aria-hidden="true">4.2.3.</strong> ROS and Arduino</a></li><li><ol class="section"><li><a href="software/ros/arduino/publisher.html"><strong aria-hidden="true">4.2.3.1.</strong> Publisher</a></li><li><a href="software/ros/arduino/subscriber.html"><strong aria-hidden="true">4.2.3.2.</strong> Subscriber</a></li></ol></li><li><a href="software/ros/advanced/advanced.html"><strong aria-hidden="true">4.2.4.</strong> Advanced concepts</a></li><li><ol class="section"><li><a href="software/ros/advanced/custom-msgs.html"><strong aria-hidden="true">4.2.4.1.</strong> Custom messages</a></li><li><a href="software/ros/advanced/model.html"><strong aria-hidden="true">4.2.4.2.</strong> Robot model</a></li><li><a href="software/ros/advanced/rviz.html"><strong aria-hidden="true">4.2.4.3.</strong> Rviz</a></li></ol></li><li><a href="software/ros/packages/packages.html"><strong aria-hidden="true">4.2.5.</strong> Useful packages</a></li><li><ol class="section"><li><a href="software/ros/packages/map.html"><strong aria-hidden="true">4.2.5.1.</strong> Map Server</a></li><li><a href="software/ros/packages/nav.html"><strong aria-hidden="true">4.2.5.2.</strong> Navigation stack</a></li></ol></li></ol></li><li><a href="software/mecanum/mecanum.html"><strong aria-hidden="true">4.3.</strong> Mecanum wheels</a></li><li><a href="software/image-processing.html"><strong aria-hidden="true">4.4.</strong> Image processing</a></li></ol></li><li><a href="robots/robots.html"><strong aria-hidden="true">5.</strong> Robots</a></li><li><ol class="section"><li><a href="robots/2018.html"><strong aria-hidden="true">5.1.</strong> 2018</a></li><li><ol class="section"><li><a href="robots/structure.html"><strong aria-hidden="true">5.1.1.</strong> Structure of folder</a></li><li><a href="robots/2018/minus/minus.html"><strong aria-hidden="true">5.1.2.</strong> Minus (big robot)</a></li><li><ol class="section"><li><a href="robots/2018/minus/architecture.html"><strong aria-hidden="true">5.1.2.1.</strong> Architecture</a></li><li><a href="robots/2018/minus/packages.html"><strong aria-hidden="true">5.1.2.2.</strong> Packages</a></li><li><a href="robots/2018/minus/howto.html"><strong aria-hidden="true">5.1.2.3.</strong> How to run the robot</a></li></ol></li></ol></li><li><a href="robots/2019.html"><strong aria-hidden="true">5.2.</strong> 2019</a></li><li><ol class="section"><li><a href="robots/2019/soja.html"><strong aria-hidden="true">5.2.1.</strong> Soja</a></li><li><ol class="section"><li><a href="robots/2019/soja/code.html"><strong aria-hidden="true">5.2.1.1.</strong> Code</a></li><li><ol class="section"><li><a href="robots/2019/soja/code/motors.html"><strong aria-hidden="true">5.2.1.1.1.</strong> Arduino/motors.ino</a></li><li><a href="robots/2019/soja/code/odom.html"><strong aria-hidden="true">5.2.1.1.2.</strong> rpi/odom.cpp</a></li><li><a href="robots/2019/soja/code/move.html"><strong aria-hidden="true">5.2.1.1.3.</strong> rpi/move.py</a></li><li><a href="robots/2019/soja/code/ultrasound_rpi.html" class="active"><strong aria-hidden="true">5.2.1.1.4.</strong> rpi/ultrasound.py</a></li></ol></li><li><a href="robots/2019/soja/Encoders.html"><strong aria-hidden="true">5.2.1.2.</strong> Encoders</a></li><li><a href="robots/2019/soja/improvements.html"><strong aria-hidden="true">5.2.1.3.</strong> Improvements</a></li></ol></li></ol></li></ol></li><li><a href="graphic/graphic_chart.html">Appendix A: Graphic chart</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Ecam Eurobot</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="robots/2019/soja/code/ultrasound_rpi.html#rpiultrasoundpy" id="rpiultrasoundpy"><h1>rpi/ultrasound.py</h1></a>
<p>In this package, all the data sent by the ultrasonic sensors are read and if the value of one sensor in front on the robot drops below a certain value (10cm in our case), it tells the arduino to pause its current action. Only when all the sensors' readings are acceptable will the robot be able to move. This is necessary for the qualifications of the robot before it can even go on the battlefield.</p>
<p>The way all this is done is pretty simple and works well. Let's analyse this program from the bottom up.</p>
<p>The following lines just tells our program to execute the <code>listener()</code> function  defined above.</p>
<pre><code class="language-python">__name__ == '__main__':
    listener()
</code></pre>
<p>Because we have 7 ultrasonic sensors each publishing on their own topic, we must subscribe to those 7 topics individually. In addition, we have to initialise the rospy node and spin it up. This is done respectively with the first and last line of the <code>listener()</code> function.</p>
<p>We also subscribe to the <code>run</code> topic, which we use to make sure the robot doesn't move after the match time is over.</p>
<pre><code class="language-python">def listener():
    rospy.init_node('ultrasound', anonymous=True)
    rospy.Subscriber('run', String, stop_cb)
    rospy.Subscriber('ultrasound_1', Range, callback, 1)
    rospy.Subscriber('ultrasound_2', Range, callback, 2)
    rospy.Subscriber('ultrasound_3', Range, callback, 3)
    rospy.Subscriber('ultrasound_4', Range, callback, 4)
    rospy.Subscriber('ultrasound_5', Range, callback, 5)
    rospy.Subscriber('ultrasound_6', Range, callback, 6)
    rospy.Subscriber('ultrasound_7', Range, callback, 7)
    rospy.spin()
</code></pre>
<p>When a message appears on one of the sensor's topic, it calls the same <code>callback()</code> function with one extra argument. That argument is there so we know which sensor is seeing the data that is being passed. This way we cam make sure that none of the sensors has an obstacle in front of it before we tell the robot it can move.</p>
<p>The way it works is that we declared a list <code>go_condition</code> that contains all boolean values. Each value corresponds to one sensor and is set to <code>True</code> when the sensor is clear and to <code>False</code> if an obstacle is present. Only when each element of that list is <code>True</code> will it continuously send the &quot;start&quot; string to the <code>cmd_stop</code> topic. If that condition is not met, it will send a &quot;stop&quot; message on the same topic. On the Arduino's side, that topic is being listened to and a boolean variable is set which will prevent going into the next iteration of the PID regulation loop and set the motors speed to 0 instead (while staying in that control loop with all other variables unaffected). The effect of this is that when the obstacle is removed and the &quot;start&quot; string is the one bieng published again, the robot simply continues where it had left as if nothing happened.</p>
<pre><code class="language-python">def callback(data, sensor_num):
    pub = rospy.Publisher('cmd_stop', String, queue_size=10)

    if (data.range &lt; 10 and data.range &gt; data.min_range):
        go_condition[sensor_num] = False
    else:
        go_condition[sensor_num] = True

    if (all(go_condition) == True):
        pub.publish(&quot;start&quot;)
    else:
        pub.publish(&quot;stop&quot;)
</code></pre>
<p>This other callback function is used to set the first entry in the <code>go_condition</code> list to false if the &quot;stop&quot; message has been received when the time is over.</p>
<p>The effect of this is the same as if one of the ultrasonic sensors had an obstacle in front of it idefinitely, keeping the robot still until everything is reset.</p>
<pre><code class="language-python">def stop_cb(msg):
    print(msg.data)
    if (msg.data == &quot;stop&quot;):
    go_condition[0] = False
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="robots/2019/soja/code/move.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="robots/2019/soja/Encoders.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="robots/2019/soja/code/move.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="robots/2019/soja/Encoders.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="searchindex.js" type="text/javascript" charset="utf-8"></script>
        
        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
